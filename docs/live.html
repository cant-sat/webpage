<body>

    <input type="text" name="Url" id="url" value="ws://localhost:12345">
    <input type="button" onclick="connect()" value="Connect" id="connect">
    <br>

    <input type="text" id="table" value="temperature" disabled="true">
    <input type="button" onclick="showTable(document.getElementById('table').value)" value="show" id="show" disabled="true">

    <br>
    <canvas id="graph"></canvas>
   
</body>

<script src="js/load.js"></script>
<script src="js/chart.js"></script>


<script>
    var tables = null

    var socket = null

    var data = {labels: [], datasets: []}
    var options = {scales: {
        y: {
            beginAtZero: true
        }
    }}
    var config = {type: "line",
        data: data,
        options : options}

    var graph = new Chart(document.getElementById("graph"), config)
    var currentGraphs = []

    function connect() {
        currentGraphs = []
        tables = new Map()
        // disables the connect buttons
        document.getElementById("url").disabled = true
        document.getElementById("connect").disabled = true

        const url = document.getElementById("url").value

        socket = new WebSocket(url)

        socket.addEventListener("close", function (event) {
            console.log("closed")

            // enables the connect buttons
            document.getElementById("url").disabled = false
            document.getElementById("connect").disabled = false

            document.getElementById("table").disabled = true
            document.getElementById("show").disabled = true
        })

        socket.addEventListener("message", function (event) {
            console.log(event.data)

            var newEntrie = JSON.parse(event.data)

            if(typeof newEntrie.table != typeof "string" || newEntrie.table == undefined || newEntrie.table == null){
                throw "error: table name error"
            }

            if (newEntrie.value == undefined && newEntrie.values != null && newEntrie.values != undefined) {
                if(typeof newEntrie.values[0] != typeof 1){
                    throw "error: only number tables are accepted"
                }
                console.log("created table " + newEntrie.table)
                tables.set(newEntrie.table, newEntrie.values)
            } else if (newEntrie.value != undefined && newEntrie.value != null && newEntrie.values == undefined) {
                if(typeof newEntrie.value != typeof 1){
                    throw "error: only numbers are accepted"
                }
                
                if(tables.has(newEntrie.table)){
                    tables.get(newEntrie.table).push(newEntrie.value)
                }
                else{
                    tables.set(newEntrie.table, [newEntrie.value])
                }
            }
            else{
                throw "error, bad message"
            }

            
        })

        socket.addEventListener("open", function () {
            document.getElementById("table").disabled = false
            document.getElementById("show").disabled = false

            console.log("Succesfully joined")
        })
    }

    function showTable(tableName){
        const visualize = tables.get(tableName)
        if (visualize != undefined && visualize != null && typeof visualize == typeof []) {

            if(currentGraphs.includes(tableName)){
                throw "error: cant visualize same graph twice"
            }
            currentGraphs.push(tableName)

            updateGraph()
        }
        else  {
            throw "error: table is empty or not array"
        }
    }

    function updateGraph(){
        if (currentGraphs.length == 0) {return}
        else{
            var longest = -1

            newData = []

            currentGraphs.forEach(element => {
                consol
                newData.push({label: element, data: tables.get(element), tension : 0, borderColor: "rgb(255, 0, 255)", fill: true})
                if(tables.get(element).length > longest){
                    longest = tables.get(element).length
                }
            });

            data.datasets = newData

            res = makeLabels(longest)
            console.log(res)

            data.labels = res
        }

        graph.update("none")
    }

    function makeLabels(size){
        ret = []
        for (let index = 0; index < size; index++) {
            ret.push(index);   
        }
        return ret
    }
  </script>